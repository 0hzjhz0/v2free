# 贰 机器指令与程序优化 - 控制流、过程调用、缓冲区溢出



## 学习目标

1. 了解基本的 CPU 架构，以及 CPU 如何进行指令计算
2. 掌握基本的汇编语法、常见的寻址方式和运算方法
3. 理解如何通过条件代码进行流程控制
4. 理解过程调用和递归的底层实现机制
5. 理解数据在内存中的存储方式
6. 了解程序在内存中的组织形式以及缓冲区溢出漏洞攻击
7. 利用代码执行的机制优化已有代码



## 基础知识

### 从C到机器代码

机器代码是处理器能够直接执行的二进制（字节层面）的程序，但可读性很差。因此，有了汇编代码，把机器码按具体含义进行『翻译 』。如果说机器码只从『执行』的角度思考，而C语言则抽象出『程序设计』的概念。从C到可执行程序需要经历若干过程，这里以 `GCC` 为例：

- C 代码（`mstore.c`）经过编译器的处理 `gcc -Og -S mstore.c` 成为汇编代码 `mstore.s`
- 汇编代码 `mstore.s` 经过汇编器的处理 `gcc` 或 `as` `gcc -Og -c mstore.c` 生成目标代码 `mstore.o`
- 目标代码 `mstore.o` 以及所需的静态库 `lib.a` 经过连接器 `gcc` 或 `ld` 的处理生成最终能被计算机执行的可执行程序

> `gcc` 是一系列工具的组合，我们平时所说的编译其实有两种意思：一是从 c 码到最终可执行文件的整个过程；一是从 c 码到汇编的过程。
>
> `-Og` 是 `gcc-4.8` 引入的优化等级，是令编译器生成符合原始 C 码整体结构的机器代码的优化等级

这里给出一个简单的demo：

```c
// sum.c
long plus(long x, long y);

void sumstore(long x, long y, long *dest)
{
    long t = plus(x, y);
    *dest = t;
}
```

执行 `gcc -Og -S sum.c` 升格汇编代码 `sum.s`：

 ```assembly

 ```

可以发现，C 代码经过编译后被处理成具有统一格式的汇编代码，第一个字符串叫作操作符，后面可能跟着 `1~3` 个以逗号分隔的操作数。



值得一提的是，处理器能够执行的操作其实非常有限，简单来说只有三种：存取数据、计算和传输控制

- 存储数据：在内存和寄存器之间传输数据
- 计算：对寄存器或者内存中的数据执行算数运算
- 传输控制：非条件跳转和条件分支



### 汇编入门







## 流程控制

### 条件码与跳转

### 循环

### switch 语句



## 过程调用





## 数据存储



## 缓冲区溢出





## 程序优化





## 总结



## 参考



代码注入攻击